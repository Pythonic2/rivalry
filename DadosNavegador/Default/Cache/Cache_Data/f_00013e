!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("crypto")):"function"==typeof define&&define.amd?define(["exports","crypto"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).xpoint={},t.require$$0)}(this,(function(t,e){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s,n=i(e);function o(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((s=s.apply(t,e||[])).next())}))}var r=new Uint8Array(16);function a(){if(!s&&!(s="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return s(r)}var c=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function d(t){return"string"==typeof t&&c.test(t)}for(var u=[],h=0;h<256;++h)u.push((h+256).toString(16).substr(1));function l(t,e,i){var s=(t=t||{}).random||(t.rng||a)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e){i=i||0;for(var n=0;n<16;++n)e[i+n]=s[n];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(u[t[e+0]]+u[t[e+1]]+u[t[e+2]]+u[t[e+3]]+"-"+u[t[e+4]]+u[t[e+5]]+"-"+u[t[e+6]]+u[t[e+7]]+"-"+u[t[e+8]]+u[t[e+9]]+"-"+u[t[e+10]]+u[t[e+11]]+u[t[e+12]]+u[t[e+13]]+u[t[e+14]]+u[t[e+15]]).toLowerCase();if(!d(i))throw TypeError("Stringified UUID is invalid");return i}(s)}var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var p={exports:{}},g={exports:{}};!function(t,e){var i;t.exports=i=i||function(t,e){var i;if("undefined"!=typeof window&&window.crypto&&(i=window.crypto),"undefined"!=typeof self&&self.crypto&&(i=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(i=globalThis.crypto),!i&&"undefined"!=typeof window&&window.msCrypto&&(i=window.msCrypto),!i&&void 0!==f&&f.crypto&&(i=f.crypto),!i)try{i=n.default}catch(t){}var s=function(){if(i){if("function"==typeof i.getRandomValues)try{return i.getRandomValues(new Uint32Array(1))[0]}catch(t){}if("function"==typeof i.randomBytes)try{return i.randomBytes(4).readInt32LE()}catch(t){}}throw new Error("Native crypto module could not be used to get secure random number.")},o=Object.create||function(){function t(){}return function(e){var i;return t.prototype=e,i=new t,t.prototype=null,i}}(),r={},a=r.lib={},c=a.Base={extend:function(t){var e=o(this);return t&&e.mixIn(t),e.hasOwnProperty("init")&&this.init!==e.init||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},d=a.WordArray=c.extend({init:function(t,i){t=this.words=t||[],this.sigBytes=i!=e?i:4*t.length},toString:function(t){return(t||h).stringify(this)},concat:function(t){var e=this.words,i=t.words,s=this.sigBytes,n=t.sigBytes;if(this.clamp(),s%4)for(var o=0;o<n;o++){var r=i[o>>>2]>>>24-o%4*8&255;e[s+o>>>2]|=r<<24-(s+o)%4*8}else for(var a=0;a<n;a+=4)e[s+a>>>2]=i[a>>>2];return this.sigBytes+=n,this},clamp:function(){var e=this.words,i=this.sigBytes;e[i>>>2]&=4294967295<<32-i%4*8,e.length=t.ceil(i/4)},clone:function(){var t=c.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var e=[],i=0;i<t;i+=4)e.push(s());return new d.init(e,t)}}),u=r.enc={},h=u.Hex={stringify:function(t){for(var e=t.words,i=t.sigBytes,s=[],n=0;n<i;n++){var o=e[n>>>2]>>>24-n%4*8&255;s.push((o>>>4).toString(16)),s.push((15&o).toString(16))}return s.join("")},parse:function(t){for(var e=t.length,i=[],s=0;s<e;s+=2)i[s>>>3]|=parseInt(t.substr(s,2),16)<<24-s%8*4;return new d.init(i,e/2)}},l=u.Latin1={stringify:function(t){for(var e=t.words,i=t.sigBytes,s=[],n=0;n<i;n++){var o=e[n>>>2]>>>24-n%4*8&255;s.push(String.fromCharCode(o))}return s.join("")},parse:function(t){for(var e=t.length,i=[],s=0;s<e;s++)i[s>>>2]|=(255&t.charCodeAt(s))<<24-s%4*8;return new d.init(i,e)}},p=u.Utf8={stringify:function(t){try{return decodeURIComponent(escape(l.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return l.parse(unescape(encodeURIComponent(t)))}},g=a.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new d.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=p.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var i,s=this._data,n=s.words,o=s.sigBytes,r=this.blockSize,a=o/(4*r),c=(a=e?t.ceil(a):t.max((0|a)-this._minBufferSize,0))*r,u=t.min(4*c,o);if(c){for(var h=0;h<c;h+=r)this._doProcessBlock(n,h);i=n.splice(0,c),s.sigBytes-=u}return new d.init(i,u)},clone:function(){var t=c.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});a.Hasher=g.extend({cfg:c.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){g.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,i){return new t.init(i).finalize(e)}},_createHmacHelper:function(t){return function(e,i){return new v.HMAC.init(t,i).finalize(e)}}});var v=r.algo={};return r}(Math)}(g),function(t,e){var i,s,n,o,r,a,c,d;t.exports=(s=(i=d=g.exports).lib,n=s.WordArray,o=s.Hasher,r=i.algo,a=[],c=r.SHA1=o.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var i=this._hash.words,s=i[0],n=i[1],o=i[2],r=i[3],c=i[4],d=0;d<80;d++){if(d<16)a[d]=0|t[e+d];else{var u=a[d-3]^a[d-8]^a[d-14]^a[d-16];a[d]=u<<1|u>>>31}var h=(s<<5|s>>>27)+c+a[d];h+=d<20?1518500249+(n&o|~n&r):d<40?1859775393+(n^o^r):d<60?(n&o|n&r|o&r)-1894007588:(n^o^r)-899497514,c=r,r=o,o=n<<30|n>>>2,n=s,s=h}i[0]=i[0]+s|0,i[1]=i[1]+n|0,i[2]=i[2]+o|0,i[3]=i[3]+r|0,i[4]=i[4]+c|0},_doFinalize:function(){var t=this._data,e=t.words,i=8*this._nDataBytes,s=8*t.sigBytes;return e[s>>>5]|=128<<24-s%32,e[14+(s+64>>>9<<4)]=Math.floor(i/4294967296),e[15+(s+64>>>9<<4)]=i,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=o.clone.call(this);return t._hash=this._hash.clone(),t}}),i.SHA1=o._createHelper(c),i.HmacSHA1=o._createHmacHelper(c),d.SHA1)}(p);var v=p.exports,y="2.0.0";class I{constructor(t,e){this.url=t,this.options=e||{}}send(t){const e=new Promise(((t,e)=>setTimeout(e,1e4,new Error("Timeout error"))));return Promise.race([this._send(t),e])}sendWithRetry(t,e,i){return o(this,void 0,void 0,(function*(){const s=new Promise(((t,e)=>setTimeout(e,1e4,new Error("Timeout error"))));return Promise.race([this._sendWithRetry(t,e,i),s])}))}_send(t){return fetch(this.url,this.options).then((e=>e.ok?new Promise(((i,s)=>{e.json().then((s=>{t&&t(e.headers,s),i(s)})).catch((t=>s(t)))})):e.json().then((t=>Promise.reject({status:e.status,statusText:e.statusText,message:t.message||t.info})))))}_sendWithRetry(t,e,i){return o(this,void 0,void 0,(function*(){try{return yield this.send(i)}catch(s){if(t>0)return yield O(e),this.sendWithRetry(t-1,e,i);throw s}}))}}const m=(t,e,i,s)=>new I(t,{method:"POST",body:e,headers:{"x-api-key":i,"content-type":"application/json"}}).sendWithRetry(1,1,s),w=t=>Math.round(1e6*t),b=(t=6e4,e=12e4)=>o(void 0,void 0,void 0,(function*(){const i=new Promise(((e,i)=>setTimeout(i,t,new Error("Unable to get current geo position"))));return Promise.race([R(t,e),i])})),R=(t,e)=>o(void 0,void 0,void 0,(function*(){if(navigator.geolocation){const i={enableHighAccuracy:!0,timeout:t,maximumAge:e},s=yield new Promise(((t,e)=>navigator.geolocation.getCurrentPosition(t,e,i)));return Promise.resolve({coords:s.coords,timestamp:(new Date).getTime()})}return new Promise((t=>t(null)))})),E=()=>k("xpjs.session"),S=t=>{D(t,"xpjs.session")},k=t=>JSON.parse(localStorage.getItem(t)||"{}"),D=(t,e)=>{localStorage.setItem(e,JSON.stringify(t))},P=(t,e,i)=>{var s,n,o;const r={accuracy:t.coords.accuracy,altitude:null!==(s=t.coords.altitude)&&void 0!==s?s:void 0,altitudeAccuracy:null!==(n=t.coords.altitudeAccuracy)&&void 0!==n?n:void 0,speed:null!==(o=t.coords.speed)&&void 0!==o?o:void 0,timestamp:t.timestamp,latitudeE6:w(t.coords.latitude),longitudeE6:w(t.coords.longitude),adId:"unknown",provider:"xpoint-lite"};return{systemInfo:{platform:"UNKNOWN",jsVersion:y},idType:"UNKNOWN",rows:[r],userKey:{deviceId:i,userId:e}}},O=t=>new Promise((e=>{setTimeout(e,1e3*t,{})}));class A{constructor(){this.timeDiffInMillis=0,this.lastTimeSnapshot=Date.now()}convertTimeToServer(t){return t-this.timeDiffInMillis}estimateDifference(t,e){this.timeDiffInMillis=null!=t?e-t:0}resetTimeModification(){this.lastTimeSnapshot=Date.now()}checkIsTimeModified(){return this.lastTimeSnapshot>Date.now()}}var L,C,T,_,j;!function(t){t.SCHEDULED="SCHEDULED",t.IN_PROGRESS="IN_PROGRESS",t.FAILED="FAILED",t.COMPLETED="COMPLETED"}(L||(L={})),function(t){t.INITIAL="INITIAL",t.RECHECK="RECHECK"}(C||(C={})),function(t){t.FORCE="FORCE",t.INTERVAL="INTERVAL",t.FORCE_CHANGE_IP="FORCE_CHANGE_IP",t.BORDER_PROXIMITY="BORDER_PROXIMITY",t.WAGERING_START="WAGERING_START"}(T||(T={})),function(t){t.FORCE="FORCE",t.FORCE_CHANGE_IP="FORCE_CHANGE_IP",t.INTERVAL="INTERVAL"}(_||(_={})),function(t){t.VERIFY="VERIFY",t.SDK="SDK",t.WEB_SDK="WEB_SDK"}(j||(j={}));class q{constructor(t,e){this.baseURL=t,this.apiKey=e}gps(t){return m(`${this.baseURL}/gps`,JSON.stringify(t),this.apiKey)}forceResult(t,e){return m(`${this.baseURL}/force-result`,JSON.stringify(t),this.apiKey,e)}initForce(t){return m(`${this.baseURL}/init-force`,JSON.stringify(t),String(this.apiKey))}checkStatus(t,e){return m(`${this.baseURL}/check-status`,JSON.stringify(t),String(this.apiKey),e)}pingApi(t){return m(`${this.baseURL}/pingapi`,JSON.stringify(t),String(this.apiKey))}}const N={code:0,description:"This site has been blocked from accessing your location. Please enable location services in browser settings."},U={code:0,description:"We cannot verify that you're within a permitted area. To help us verify your location make sure your Location Services is turned on and that multiple WiFi connections are within range of your device. Please, address items above then try again."},x={code:0,description:"The service is temporarily overloaded. Please try again later."},M={code:3006,description:"We have detected that the device time has been modified. Please correct the time on your device to match your time zone, then try again."},W=9e5;class B{constructor(t,e){this.webSdk=t,this.tokenInterceptor=e,this._init()}startPolling(t){window.clearInterval(this.pollingTimerTask),this.pollingTimerTask=window.setInterval(this._checkStatus,t||1e3,this.webSdk)}stopPolling(){window.clearInterval(this.pollingTimerTask)}_checkStatus(t){return o(this,void 0,void 0,(function*(){document.hidden||t.checkStatus(this.tokenInterceptor).then((t=>{B._checkRequestUpdated(t)})).catch((t=>{404===t.status?B._checkRequestUpdated({status:"WAITING"}):B._checkRequestUpdated({})}))}))}_init(){this._initListeners(),this._startSendingLocationData()}_initListeners(){const t=this.stopPolling.bind(this),e=this.startPolling.bind(this);window.addEventListener("xpoint-sdk-message",(i=>{const s=i.detail;s.status&&"DENIED"!==s.status?"ALLOWED"===s.status&&e(1e4):t()}))}static _checkRequestUpdated(t){window.dispatchEvent(new CustomEvent("xpoint-sdk-message",{detail:t}))}_sendLocationData(t){if(!document.hidden){const e=e=>{t.sendEvent({location:{lat:e.coords.latitude,lon:e.coords.longitude,accuracy:e.coords.accuracy},timestamp:e.timestamp})},i=t=>{console.warn(`ERROR(${t.code}): ${t.message}`)},s={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};navigator.geolocation.getCurrentPosition(e,i,s)}}_startSendingLocationData(){this._sendLocationData(this.webSdk),setInterval(this._sendLocationData,3e4,this.webSdk)}}const H=[...[18354,18355,18356].map((t=>`http://127.0.0.1:${t}`)),...[28354,28355,28356].map((t=>`https://local.xpoint.tech:${t}`))];class ${constructor(){this.baseURL="",this.version=y,this.ensureApiIsAvailable()}ensureApiIsAvailable(){return o(this,void 0,void 0,(function*(){return this.baseURL||(this.baseURL=yield $.findLocalServiceUrl()),this.baseURL}))}health(){return o(this,void 0,void 0,(function*(){return yield this.ensureApiIsAvailable(),new I(this.baseURL+"/status").send()}))}login(t){return o(this,void 0,void 0,(function*(){yield this.ensureApiIsAvailable();const e=((t,e)=>{const i=new URL("login",t);return i.searchParams.append("userId",e.userId),e.client&&i.searchParams.append("client",e.client),e.customData&&i.searchParams.append("customData",e.customData),e.clientBrand&&i.searchParams.append("clientBrand",e.clientBrand),i.toString()})(this.baseURL,t);return new I(e).send()}))}wageringStart(){return o(this,void 0,void 0,(function*(){yield this.ensureApiIsAvailable();const t=new URL(`${this.baseURL}/wagering-start`);return t.searchParams.append("v",this.version),new I(t.toString()).send()}))}checkStatus(t){return o(this,void 0,void 0,(function*(){return yield this.ensureApiIsAvailable(),new I(`${this.baseURL}/check-status`).send(t)}))}wageringEnd(){return o(this,void 0,void 0,(function*(){return yield this.ensureApiIsAvailable(),new I(`${this.baseURL}/wagering-end`).send()}))}logout(){return o(this,void 0,void 0,(function*(){return yield this.ensureApiIsAvailable(),new I(`${this.baseURL}/logout`).send()}))}sendEvent(t){return o(this,void 0,void 0,(function*(){yield this.ensureApiIsAvailable();const e=new URL(`${this.baseURL}/send-event`);return Object.entries(t).forEach((([t,i])=>e.searchParams.append(t,JSON.stringify(i)))),new I(e.toString()).send()}))}static findLocalServiceUrl(){return o(this,void 0,void 0,(function*(){let t;for(let e=0;e<H.length;e++)try{yield new I(H[e]+"/status").send(),t=H[e];break}catch(t){}if(!t)throw new Error("Local service is not launched");return t}))}}const F=class{constructor(){this.webSdk=new $,this.webSdkDaemon=new B(this.webSdk,this.tokenInterceptor((t=>(null==t?void 0:t.requestId)||"")))}setUserId(t,e,i,s){return o(this,void 0,void 0,(function*(){this.loginOptions=Object.assign(Object.assign(Object.assign({userId:t},e?{client:e}:null),i?{customData:i}:null),s?{clientBrand:s}:null);try{yield this.loginIfNeeded(this.loginOptions)}catch(t){}return t}))}loginIfNeeded(t){return o(this,void 0,void 0,(function*(){if(!t||!t.userId)return Promise.reject("userId is required");const e=yield this.webSdk.health(),i=null==e?void 0:e.session;t.userId==(null==i?void 0:i.userId)&&t.client==(null==i?void 0:i.client)&&t.customData==(null==i?void 0:i.customData)&&t.clientBrand===(null==i?void 0:i.clientBrand)||(yield this.webSdk.login(t))}))}wageringStart(){var t;return o(this,void 0,void 0,(function*(){if(!this.loginOptions||!(null===(t=this.loginOptions)||void 0===t?void 0:t.userId))return Promise.reject("Set userId before starting game.");yield this.loginIfNeeded(this.loginOptions);(yield this.webSdk.health()).session.activeGame||(yield this.webSdk.wageringStart()),this.webSdkDaemon.startPolling()}))}wageringEnd(){return o(this,void 0,void 0,(function*(){this.webSdkDaemon.stopPolling(),yield this.webSdk.wageringEnd()}))}logout(){return o(this,void 0,void 0,(function*(){this.webSdkDaemon.stopPolling(),yield this.webSdk.wageringEnd(),yield this.webSdk.logout()}))}checkStatus(){return o(this,void 0,void 0,(function*(){return this.webSdk.checkStatus(this.tokenInterceptor((t=>(null==t?void 0:t.requestId)||"")))}))}getRequestMetadata(t){var e;return o(this,void 0,void 0,(function*(){const i=(null===(e=this.checkRequestMetadataMap)||void 0===e?void 0:e[t])||{};return Promise.resolve(i)}))}liteCheck(){throw new Error("Not implemented")}tokenInterceptor(t){return(e,i)=>{const s=e.get("xpoint-jwt");if(s){const e=t(i);e?this.checkRequestMetadataMap={[e]:{checkRequestToken:s}}:console.error("Can't get requestId from response body")}}}},G=class{constructor(t){this.session={},this.currentPosition=null,this.watchPositionHandlerId=null,this.baseURL=(t=>{const e=null!=t?t:localStorage.getItem("xpjs.apiHost");return e&&/xp23.xpoint.tech$/i.test(e)?`https://${e}`:"https://xp23.xpoint.tech"})(t),this.webSdkLite=new q(this.baseURL,""),this.serverTimeEstimator=new A,this.init()}init(){this.session.deviceId=E().deviceId,this.session.deviceId||(this.session.deviceId=l(),(t=>{const e=Object.assign(Object.assign({},E()),t);S(e)})({deviceId:this.session.deviceId})),this.startSendingGps(),this.startSendingPingApi(),this.checkStatusPeriodically()}setUserId(t,e,i,s){return o(this,void 0,void 0,(function*(){var n;return this.session=Object.assign(Object.assign({},this.session),{userId:t,client:e,customData:i,clientBrand:s,apiKey:(n=e||"default",v(`O50rhDrqW6POa1jIDAKK^${n.length}${n.toLowerCase()}`).toString())}),this.webSdkLite=new q(this.baseURL,String(this.session.apiKey)),t}))}wageringStart(){return o(this,void 0,void 0,(function*(){if(this.serverTimeEstimator.resetTimeModification(),!this.session.userId)return Promise.reject("Set userId before starting game.");this.session.activeGame||(this.startWatchingPositionOnce(),this.session.activeGame=!0,yield this.sendPingApi(),this.checkRequestUpdated({status:"WAITING"}),this.sendInitForceAndWaitForceResult())}))}wageringEnd(){return o(this,void 0,void 0,(function*(){this.session.activeGame=!1}))}logout(){return o(this,void 0,void 0,(function*(){this.session.userId=void 0,this.session.client=void 0,this.session.customData=void 0,this.session.apiKey=void 0,this.session.activeGame=!1,this.session.checkStatus=void 0,this.session.checkStatusExpiresAt=void 0,this.session.checkRequestMetadataMap=void 0}))}liteCheck(){var t,e;return o(this,void 0,void 0,(function*(){if(!this.session.userId)return Promise.reject("Set userId before starting game.");const i=yield this.getMostRecentPosition().catch((t=>{console.warn(`ERROR(${t.code}): ${t.message}`)}));if(i){const s=P(i,String(this.session.userId),String(this.session.deviceId));this.webSdkLite.gps(s).catch((t=>console.log(t))),this.sendPingApi();const n=l();let o,r;try{o=yield this.webSdkLite.initForce({clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{requestId:n,initialRequestId:n})});const t=1,e=12e4,i=this.now();for(;(null==r?void 0:r.jobStatus)!==L.COMPLETED&&(null==r?void 0:r.jobStatus)!==L.FAILED&&this.now()-i<e;){yield O(t);const e=l();r=yield this.webSdkLite.forceResult({jobId:o.jobId,clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{requestId:e,initialRequestId:e})},this.tokenInterceptor((t=>{var e;return null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.requestId})))}}catch(t){return{status:"DENIED",errors:[U]}}if(r&&r.jobStatus===L.COMPLETED){const i=null===(e=null===(t=this.session.checkRequestMetadataMap)||void 0===t?void 0:t[r.data.requestId])||void 0===e?void 0:e.checkRequestToken;return Object.assign(Object.assign({},r.data),i?{jwt:i}:null)}return{status:"DENIED",errors:[x]}}return{status:"DENIED",errors:[N]}}))}checkStatus(){var t;return o(this,void 0,void 0,(function*(){return null!==(t=this.session.checkStatus)&&void 0!==t?t:{status:"WAITING"}}))}sendInitForceAndWaitForceResult(){return o(this,void 0,void 0,(function*(){const t=yield this.getMostRecentPosition().catch((t=>{console.warn(`ERROR(${t.code}): ${t.message}`)}));if(t){const e=P(t,String(this.session.userId),String(this.session.deviceId));yield this.webSdkLite.gps(e).catch((t=>console.log(t))),yield O(1);const i=l();let s,n;try{s=yield this.webSdkLite.initForce({clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{requestId:i,initialRequestId:i})});const t=1,e=12e4,o=this.now();for(;(null==n?void 0:n.jobStatus)!==L.COMPLETED&&(null==n?void 0:n.jobStatus)!==L.FAILED&&this.session.activeGame&&this.now()-o<e;){yield O(t);const e=l();n=yield this.webSdkLite.forceResult({jobId:s.jobId,clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{requestId:e,initialRequestId:e})},this.tokenInterceptor((t=>{var e;return null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.requestId})))}}catch(t){this.checkRequestUpdated({status:"DENIED",errors:[U]}),yield this.wageringEnd()}n&&n.jobStatus===L.COMPLETED?(this.checkRequestUpdated(n.data),"ALLOWED"===n.data.status||"DENIED"===n.data.status&&(yield this.wageringEnd())):(this.checkRequestUpdated({status:"DENIED",errors:[x]}),yield this.wageringEnd())}else this.checkRequestUpdated({status:"DENIED",errors:[N]}),yield this.wageringEnd()}))}checkStatusPeriodically(){var t,e;return o(this,void 0,void 0,(function*(){for(;;)if(yield O(1),this.session.activeGame&&"ALLOWED"===(null===(t=this.session.checkStatus)||void 0===t?void 0:t.status)&&this.session.checkStatusExpiresAt&&this.now()>this.session.checkStatusExpiresAt){const t=yield this.getMostRecentPosition().catch((t=>{console.warn(`ERROR(${t.code}): ${t.message}`)}));if(t){let i;const s=l();try{const e=P(t,String(this.session.userId),String(this.session.deviceId));yield this.webSdkLite.gps(e).catch((t=>console.log(t))),yield O(10),i=yield this.webSdkLite.checkStatus({clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{requestId:s,initialRequestId:s})},this.tokenInterceptor((t=>null==t?void 0:t.requestId)))}catch(t){i=yield this.recheckCheckRequest(s)}i?"DENIED"===i.status?(this.session.checkStatusExpiresAt=i.nextCheckInterval?this.now()+1e3*i.nextCheckInterval:void 0,this.recheckAndWaitForResult((null===(e=this.session.checkStatus)||void 0===e?void 0:e.nextCheckType)||T.INTERVAL,C.RECHECK,s,1)):this.checkRequestUpdated(i):(this.checkRequestUpdated({status:"DENIED",errors:[U]}),yield this.wageringEnd())}else this.checkRequestUpdated({status:"DENIED",errors:[N]}),yield this.wageringEnd()}}))}recheckAndWaitForResult(t,e,i,s=1){return o(this,void 0,void 0,(function*(){const n=yield this.getMostRecentPosition().catch((t=>{console.warn(`ERROR(${t.code}): ${t.message}`)}));if(n){const o=P(n,String(this.session.userId),String(this.session.deviceId)),r=l(),a=r;let c;try{yield this.webSdkLite.gps(o).catch((t=>console.log(t))),yield O(1);const s=yield this.webSdkLite.initForce({clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo(e)),{requestType:t,initialRequestId:null!=i?i:r,requestId:r})}),n=1,a=12e4,d=this.now();for(;(null==c?void 0:c.jobStatus)!==L.COMPLETED&&(null==c?void 0:c.jobStatus)!==L.FAILED&&this.session.activeGame&&this.now()-d<a;){yield O(n);const t=l();c=yield this.webSdkLite.forceResult({jobId:s.jobId,clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo(e)),{initialRequestId:null!=i?i:t,requestId:t})},this.tokenInterceptor((t=>{var e;return null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.requestId})))}}catch(t){yield O(5)}c&&c.jobStatus!==L.FAILED&&"DENIED"!==c.data.status?c.jobStatus===L.COMPLETED&&"ALLOWED"===c.data.status?this.checkRequestUpdated(c.data):(this.checkRequestUpdated(c?c.data:{status:"DENIED",errors:[x]}),yield this.wageringEnd()):s<4?this.recheckAndWaitForResult(t,C.RECHECK,i||a,s+1):(this.checkRequestUpdated(c?c.data:{status:"DENIED",errors:[U]}),yield this.wageringEnd())}else this.checkRequestUpdated({status:"DENIED",errors:[N]}),yield this.wageringEnd()}))}recheckCheckRequest(t){return o(this,void 0,void 0,(function*(){let e=0;let i;for(;!i&&e++<4;){yield O(10);try{const e=l();i=yield this.webSdkLite.checkStatus({clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{checkPhase:C.RECHECK,requestId:e,initialRequestId:t})},this.tokenInterceptor((t=>null==t?void 0:t.requestId)))}catch(t){}}return i}))}startSendingGps(){return o(this,void 0,void 0,(function*(){for(;;){yield O(420);try{if(this.session.userId){const t=yield this.getMostRecentPosition().catch((t=>{console.warn(`ERROR(${t.code}): ${t.message}`)}));if(t){const e=P(t,String(this.session.userId),String(this.session.deviceId));yield this.webSdkLite.gps(e)}}}catch(t){}}}))}startSendingPingApi(){return o(this,void 0,void 0,(function*(){for(;;){yield O(60);try{if(this.session.activeGame){(yield this.sendPingApi()).code===_.FORCE_CHANGE_IP&&this.recheckAndWaitForResult(T.FORCE_CHANGE_IP,C.INITIAL,null,0)}}catch(t){}}}))}sendPingApi(){return o(this,void 0,void 0,(function*(){this.serverTimeEstimator.checkIsTimeModified()&&(this.wageringEnd(),this.checkRequestUpdated({status:"DENIED",errors:[M]}));const t=Date.now(),e=yield this.webSdkLite.pingApi({clientInfo:Object.assign(Object.assign({},this.getCurrentClientInfo()),{requestId:l()})});return this.serverTimeEstimator.estimateDifference(e.serverTime,t),e}))}getCurrentClientInfo(t=C.INITIAL){var e;return((t,e,i,s,n,o)=>Object.assign(Object.assign(Object.assign({userId:t,deviceId:e,systemInfo:{platform:"UNKNOWN",jsVersion:y},deviceInfo:{brand:"UNKNOWN",model:"UNKNOWN",osVersion:"UNKNOWN"}},n?{customData:n}:null),o?{clientBrand:o}:null),{requestType:i,checkPhase:s}))(String(this.session.userId),String(this.session.deviceId),(null===(e=this.session.checkStatus)||void 0===e?void 0:e.nextCheckType)||T.WAGERING_START,t,this.session.customData,this.session.clientBrand)}checkRequestUpdated(t){var e;this.session.checkStatus=t,this.session.checkStatusExpiresAt=t.nextCheckInterval?this.now()+1e3*t.nextCheckInterval:void 0;const i=t.requestId;this.session.checkRequestMetadataMap=i&&(null===(e=this.session.checkRequestMetadataMap)||void 0===e?void 0:e[i])?{[i]:this.session.checkRequestMetadataMap[i]}:{},window.dispatchEvent(new CustomEvent("xpoint-sdk-message",{detail:t}))}tokenInterceptor(t){return(e,i)=>{const s=e.get("xpoint-jwt");if(s){const e=t(i);this.session.checkRequestMetadataMap||(this.session.checkRequestMetadataMap={}),e?this.session.checkRequestMetadataMap[e]={checkRequestToken:s}:console.error("Can't get requestId from response body")}}}getRequestMetadata(t){var e;const i=(null===(e=this.session.checkRequestMetadataMap)||void 0===e?void 0:e[t])||{};return Promise.resolve(i)}startWatchingPositionOnce(){return o(this,void 0,void 0,(function*(){if(this.watchPositionHandlerId||!navigator.geolocation)return;const t={enableHighAccuracy:!0,positionRetrieveTimeout:6e4,positionMaximumAge:W};for(this.watchPositionHandlerId=navigator.geolocation.watchPosition((t=>this.positionUpdated(t)),(()=>{}),t);;)if(yield O(30),!this.isCurrentPositionValid()){const t=yield b().catch((t=>{console.warn(`ERROR(${t.code}): ${t.message}`)}));t&&this.positionUpdated(t)}}))}isCurrentPositionValid(){var t;return!!((null===(t=this.currentPosition)||void 0===t?void 0:t.timestamp)&&this.currentPosition.timestamp>this.now()-W)}positionUpdated(t){this.currentPosition={coords:t.coords,timestamp:this.now()}}getMostRecentPosition(){return o(this,void 0,void 0,(function*(){if(this.isCurrentPositionValid())return Promise.resolve(this.currentPosition);const t=yield b(6e4,W);return t?(this.positionUpdated(t),this.currentPosition):null}))}now(){return this.serverTimeEstimator.convertTimeToServer(Date.now())}};var K={WebSdk:F,WebSdkLite:G};t.WebSdk=F,t.WebSdkLite=G,t.default=K,Object.defineProperty(t,"__esModule",{value:!0})}));
